<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico Completo - Sistema de Senhas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            color: #333;
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 32px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }
        
        .section h2 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 14px;
            margin: 5px;
        }
        
        .status.ok {
            background: #10b981;
            color: white;
        }
        
        .status.error {
            background: #ef4444;
            color: white;
        }
        
        .status.warning {
            background: #f59e0b;
            color: white;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        button.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }
        
        .card h3 {
            color: #1e3a8a;
            margin-bottom: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Completo do Sistema</h1>
        
        <div class="section">
            <h2>üé¨ A√ß√µes R√°pidas</h2>
            <button onclick="diagnosticar()">üîç Diagnosticar Tudo</button>
            <button onclick="corrigirData()">üìÖ Corrigir Data</button>
            <button onclick="forcarLogin()" class="success">üë§ For√ßar Login (C√≥digo 1)</button>
            <button onclick="criarGuiche()" class="success">üè¢ Criar Guich√™ para C√≥digo 1</button>
        </div>
        
        <div id="resultados"></div>
    </div>

    <script>
        function diagnosticar() {
            const resultados = document.getElementById('resultados');
            resultados.innerHTML = '';
            
            let html = '';
            
            // 1. Verificar funcion√°rio logado
            html += '<div class="section"><h2>üë§ Funcion√°rio Logado</h2>';
            const user = localStorage.getItem('user');
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    html += '<div class="status ok">‚úÖ LOGADO</div>';
                    html += '<pre>' + JSON.stringify(userData, null, 2) + '</pre>';
                } catch (e) {
                    html += '<div class="status error">‚ùå ERRO ao fazer parse</div>';
                }
            } else {
                html += '<div class="status error">‚ùå N√ÉO LOGADO</div>';
                html += '<p>Use o bot√£o "For√ßar Login" acima para logar automaticamente.</p>';
            }
            html += '</div>';
            
            // 2. Verificar funcion√°rios cadastrados
            html += '<div class="section"><h2>üìã Funcion√°rios Cadastrados</h2>';
            const funcionarios = localStorage.getItem('funcionarios-cadastrados');
            if (funcionarios) {
                try {
                    const funcArray = JSON.parse(funcionarios);
                    html += '<div class="status ok">‚úÖ ' + funcArray.length + ' funcion√°rio(s)</div>';
                    html += '<div class="grid">';
                    funcArray.forEach(f => {
                        html += '<div class="card">';
                        html += '<h3>üë§ ' + f.nome + '</h3>';
                        html += '<p><strong>C√≥digo:</strong> ' + f.codigo + '</p>';
                        html += '<p><strong>Login:</strong> ' + (f.login || 'N/A') + '</p>';
                        html += '<p><strong>Senha:</strong> ' + (f.senha || 'N/A') + '</p>';
                        html += '</div>';
                    });
                    html += '</div>';
                } catch (e) {
                    html += '<div class="status error">‚ùå ERRO ao fazer parse</div>';
                }
            } else {
                html += '<div class="status error">‚ùå Nenhum funcion√°rio cadastrado</div>';
            }
            html += '</div>';
            
            // 3. Verificar guich√™s
            html += '<div class="section"><h2>üè¢ Guich√™s Cadastrados</h2>';
            const guiches = localStorage.getItem('senha-guiches');
            if (guiches) {
                try {
                    const guichesArray = JSON.parse(guiches);
                    html += '<div class="status ok">‚úÖ ' + guichesArray.length + ' guich√™(s)</div>';
                    html += '<div class="grid">';
                    guichesArray.forEach(g => {
                        html += '<div class="card">';
                        html += '<h3>üè¢ Guich√™ ' + g.numero + '</h3>';
                        html += '<p><strong>Nome:</strong> ' + g.nome + '</p>';
                        html += '<p><strong>Funcion√°rio ID:</strong> ' + (g.funcionarioId || 'N/A') + ' (tipo: ' + typeof g.funcionarioId + ')</p>';
                        html += '<p><strong>Funcion√°rio Nome:</strong> ' + (g.funcionarioNome || 'N/A') + '</p>';
                        html += '<p><strong>Ativo:</strong> ' + (g.ativo ? '‚úÖ Sim' : '‚ùå N√£o') + '</p>';
                        html += '</div>';
                    });
                    html += '</div>';
                } catch (e) {
                    html += '<div class="status error">‚ùå ERRO ao fazer parse</div>';
                }
            } else {
                html += '<div class="status error">‚ùå Nenhum guich√™ cadastrado</div>';
                html += '<p>Use o bot√£o "Criar Guich√™" acima.</p>';
            }
            html += '</div>';
            
            // 4. Verificar senhas
            html += '<div class="section"><h2>üé´ Senhas no Sistema</h2>';
            const senhas = localStorage.getItem('senha-senhas');
            if (senhas) {
                try {
                    const senhasArray = JSON.parse(senhas);
                    html += '<div class="status ok">‚úÖ ' + senhasArray.length + ' senha(s)</div>';
                    const aguardando = senhasArray.filter(s => s.status === 'aguardando').length;
                    html += '<p><strong>Aguardando:</strong> ' + aguardando + '</p>';
                    if (senhasArray.length > 0) {
                        html += '<div class="grid">';
                        senhasArray.slice(0, 6).forEach(s => {
                            html += '<div class="card">';
                            html += '<h3>' + s.numeroCompleto + '</h3>';
                            html += '<p><strong>Status:</strong> ' + s.status + '</p>';
                            html += '<p><strong>Servi√ßo:</strong> ' + s.servico.nome + '</p>';
                            html += '</div>';
                        });
                        html += '</div>';
                    }
                } catch (e) {
                    html += '<div class="status error">‚ùå ERRO ao fazer parse</div>';
                }
            } else {
                html += '<div class="status warning">‚ö†Ô∏è Nenhuma senha emitida</div>';
            }
            html += '</div>';
            
            // 5. Verificar compatibilidade
            html += '<div class="section"><h2>üîó Verificar Compatibilidade</h2>';
            if (user && guiches) {
                try {
                    const userData = JSON.parse(user);
                    const guichesArray = JSON.parse(guiches);
                    
                    const userCodigo = userData.codigo || userData.id;
                    const userId = userData.id;
                    
                    html += '<p><strong>User C√≥digo:</strong> ' + userCodigo + ' (tipo: ' + typeof userCodigo + ')</p>';
                    html += '<p><strong>User ID:</strong> ' + userId + ' (tipo: ' + typeof userId + ')</p>';
                    
                    const guicheEncontrado = guichesArray.find(g => {
                        const match = (
                            String(g.funcionarioId) === String(userCodigo) ||
                            String(g.funcionarioId) === String(userId) ||
                            g.funcionarioId === userCodigo ||
                            g.funcionarioId === userId
                        );
                        return match;
                    });
                    
                    if (guicheEncontrado) {
                        html += '<div class="status ok">‚úÖ GUICH√ä ENCONTRADO: ' + guicheEncontrado.numero + '</div>';
                    } else {
                        html += '<div class="status error">‚ùå NENHUM GUICH√ä COMPAT√çVEL</div>';
                        html += '<p>Use o bot√£o "Criar Guich√™" para resolver.</p>';
                    }
                } catch (e) {
                    html += '<div class="status error">‚ùå ERRO: ' + e.message + '</div>';
                }
            } else {
                html += '<div class="status warning">‚ö†Ô∏è Faltam dados para verificar</div>';
            }
            html += '</div>';
            
            resultados.innerHTML = html;
        }
        
        function corrigirData() {
            const hoje = new Date().toDateString();
            localStorage.setItem('senha-ultima-data', hoje);
            alert('‚úÖ Data corrigida! Senhas n√£o ser√£o limpadas.');
            diagnosticar();
        }
        
        function forcarLogin() {
            const funcionarios = localStorage.getItem('funcionarios-cadastrados');
            if (!funcionarios) {
                alert('‚ùå Nenhum funcion√°rio cadastrado!');
                return;
            }
            
            const funcArray = JSON.parse(funcionarios);
            const func1 = funcArray.find(f => f.codigo === 1 || f.codigo === '1');
            
            if (!func1) {
                alert('‚ùå Funcion√°rio com c√≥digo 1 n√£o encontrado!');
                return;
            }
            
            const userData = {
                id: func1.id || func1.codigo,
                codigo: func1.codigo || func1.id,
                email: func1.email || 'funcionario@sistema.com',
                name: func1.nome,
                nome: func1.nome,
                login: func1.login || func1.email,
                profile: 'employee',
                permissions: ['read', 'create'],
                funcionario: func1
            };
            
            const token = 'funcionario-token-' + Date.now();
            localStorage.setItem('token', token);
            localStorage.setItem('user', JSON.stringify(userData));
            
            alert('‚úÖ Login for√ßado com sucesso!\n\nFuncion√°rio: ' + func1.nome + '\nC√≥digo: ' + func1.codigo);
            diagnosticar();
        }
        
        function criarGuiche() {
            const user = localStorage.getItem('user');
            if (!user) {
                alert('‚ùå Fa√ßa login primeiro! Use o bot√£o "For√ßar Login".');
                return;
            }
            
            const userData = JSON.parse(user);
            const guichesExistentes = JSON.parse(localStorage.getItem('senha-guiches') || '[]');
            
            // Verificar se j√° existe guich√™ para este usu√°rio
            const jaExiste = guichesExistentes.find(g => 
                String(g.funcionarioId) === String(userData.codigo) ||
                String(g.funcionarioId) === String(userData.id)
            );
            
            if (jaExiste) {
                alert('‚ÑπÔ∏è J√° existe um guich√™ para este funcion√°rio!\n\nGuich√™: ' + jaExiste.numero);
                diagnosticar();
                return;
            }
            
            const novoNumero = guichesExistentes.length > 0 ? Math.max(...guichesExistentes.map(g => g.numero)) + 1 : 1;
            
            const novoGuiche = {
                id: 'guiche-' + Date.now(),
                numero: novoNumero,
                nome: 'Guich√™ ' + novoNumero,
                ativo: true,
                funcionarioId: userData.codigo || userData.id,
                funcionarioNome: userData.name || userData.nome,
                servicosAtendidos: ['preferencial', 'comum'],
                statusGuiche: 'livre'
            };
            
            guichesExistentes.push(novoGuiche);
            localStorage.setItem('senha-guiches', JSON.stringify(guichesExistentes));
            
            alert('‚úÖ Guich√™ criado com sucesso!\n\nN√∫mero: ' + novoNumero + '\nFuncion√°rio: ' + novoGuiche.funcionarioNome);
            diagnosticar();
        }
        
        // Auto-diagnosticar ao carregar
        window.addEventListener('DOMContentLoaded', diagnosticar);
    </script>
</body>
</html>

